<!-- <script type="text/javascript" src="https://unpkg.com/webmidi"></script> 
    <script type="text/javascript" src="../static/js/build2/Piano.js"></script> -->
<script type="text/javascript">
    // PianoKeys - Piano keyboard rendered as SVG
    //
    // https://github.com/jesperdj/pianokeys
    // https://www.npmjs.com/package/@jesperdj/pianokeys
    //
    // MIT License
    // 
    // Copyright (c) 2021 Jesper de Jong
    // 
    // Permission is hereby granted, free of charge, to any person obtaining a copy
    // of this software and associated documentation files (the "Software"), to deal
    // in the Software without restriction, including without limitation the rights
    // to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    // copies of the Software, and to permit persons to whom the Software is
    // furnished to do so, subject to the following conditions:
    // 
    // The above copyright notice and this permission notice shall be included in all
    // copies or substantial portions of the Software.
    // 
    // THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    // IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    // FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    // AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    // LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    // OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    // SOFTWARE.

    function parseNoteName(noteName) {
        class NoteNameParseError extends Error {
            constructor() {
                super('Invalid note name: ' + noteName);
                this.name = 'NoteNameParseError';
                this.noteName = noteName;
            }
        }

        function parseLetter(letter) {
            if (letter == '-') throw new NoteNameParseError();
            const value = 'C-D-EF-G-A-B'.indexOf(letter);
            if (value == -1) throw new NoteNameParseError();
            return value;
        }

        function parseAccidental(accidental) {
            switch (accidental) {
                case 'b': return -1;
                case '#': return 1;
                default: throw new NoteNameParseError();
            }
        }

        function parseOctave(octave) {
            const value = '0123456789'.indexOf(octave);
            if (value == -1) throw new NoteNameParseError();
            return 12 * value;
        }

        switch (noteName.length) {
            case 2: return parseLetter(noteName[0]) + parseOctave(noteName[1]);
            case 3: return parseLetter(noteName[0]) + parseAccidental(noteName[1]) + parseOctave(noteName[2]);
            default: throw new NoteNameParseError();
        }
    }

    function getOctave(note) {
        return Math.floor(note / 12);
    }

    function getPitchClass(note) {
        return note % 12;
    }

    const WHITE_KEYS = [0, 2, 4, 5, 7, 9, 11];
    const BLACK_KEYS = [1, 3, 6, 8, 10];

    function isWhiteKey(note) {
        return WHITE_KEYS.indexOf(getPitchClass(note)) >= 0;
    }

    function isBlackKey(note) {
        return BLACK_KEYS.indexOf(getPitchClass(note)) >= 0;
    }

    function createSvgElement(tag, attrs = {}) {
        const element = document.createElementNS('http://www.w3.org/2000/svg', tag);
        for (const [key, value] of Object.entries(attrs)) {
            element.setAttribute(key, value);
        }
        return element;
    }

    function getNoteName(note) {

        for (let i = 0; i < note; i++) {

        }
    }

    const KEY_POSITIONS = [1, 18, 25, 42, 49, 73, 90, 97, 114, 121, 138, 145];
    const keynames = ["A", "B", "C", "D", "E", "F", "G"];
    const keynames_b = ["B", "D", "E", "G", "A"];
    class Keyboard {
        constructor(container, options = {}) {
            let lowest = parseNoteName(options.lowest || 'A0');
            if (isBlackKey(lowest)) lowest--;
            if (lowest < 0) lowest = 0;

            let highest = parseNoteName(options.highest || 'C8');
            if (isBlackKey(highest)) highest++;

            if (highest < lowest) throw new RangeError('Highest note must not be lower than lowest note.');

            const keyStroke = options.keyStroke || 'black';

            const whiteKeyFill = options.whiteKeyFill || 'white';
            this._whiteKeyFill = whiteKeyFill;
            this._whiteKeyHighlightFill = options.whiteKeyHighlightFill || '#ff9e85';

            const blackKeyFill = options.blackKeyFill || 'black';
            this._blackKeyFill = blackKeyFill;
            this._blackKeyHighlightFill = options.blackKeyHighlightFill || '#ff8f72';

            const keys = [];
            const whiteKeys = [];
            const blackKeys = [];

            const offset = 168 * getOctave(lowest) + KEY_POSITIONS[getPitchClass(lowest)] - 1;

            let whiteCount = 0;
            let whiteCount2 = 5;
            let blackCount = 0;
            let blackCount2 = 4;
            for (let note = lowest; note <= highest; note++) {
                const x = 168 * getOctave(note) + KEY_POSITIONS[getPitchClass(note)] - offset;

                const whiteKey = isWhiteKey(note);
                const attrs = whiteKey ?
                    { x, y: 1, width: 24, height: 140, rx: 2, ry: 2, stroke: keyStroke, 'stroke-width': 2, fill: whiteKeyFill } :
                    { x, y: 1, width: 14, height: 90, rx: 2, ry: 2, stroke: keyStroke, 'stroke-width': 2, fill: blackKeyFill };

                const key = createSvgElement('rect', attrs);
                if (whiteKey) {
                    key.id = keynames[whiteCount % 7] + Math.floor(whiteCount2 / 7);
                    whiteCount++;
                    whiteCount2++;
                } else {
                    key.id = keynames_b[blackCount % 5] + "b" + Math.floor(blackCount2 / 5);
                    blackCount++;
                    blackCount2++;
                }
                key.setAttribute('class', "keyboardbtn");
                key.setAttribute('count', note + 12);
                keys[note] = key;
                if (whiteKey) whiteKeys.push(key); else blackKeys.push(key);
            }

            this._keys = keys;

            // Why it's better to set viewBox instead of width and height: https://css-tricks.com/scale-svg/
            const width = 2 + 24 * whiteKeys.length;
            const svg = createSvgElement('svg', { viewBox: `0 0 ${width} 142` });

            // First add white keys and then black keys, so that the black keys are drawn on top
            for (const whiteKey of whiteKeys) svg.appendChild(whiteKey);
            for (const blackKey of blackKeys) svg.appendChild(blackKey);

            container.appendChild(svg);
        }

        fillKey(noteName, fill) {
            const note = parseNoteName(noteName);

            const key = this._keys[note];

            if (key) key.setAttribute('fill', fill ? fill : (isWhiteKey(note) ? this._whiteKeyHighlightFill : this._blackKeyHighlightFill));
        }

        clearKey(noteName) {
            const note = parseNoteName(noteName);
            const key = this._keys[note];
            if (key) key.setAttribute('fill', isWhiteKey(note) ? this._whiteKeyFill : this._blackKeyFill);
        }
    }

    const PianoKeys = { Keyboard };
</script>
<script type="text/javascript" src="https://tonejs.github.io/build/Tone.js"></script>
<div>
    <style type="text/css">
        body {
            width: 100%;
            height: auto;
            max-width: 960px;
            margin: auto;
            margin-top: 80px;
            font-family: monospace;
            font-size: 1.25em;
        }

        a {
            text-decoration: none;
            font-weight: bold;
            color: black;
        }

        a:hover {
            color: blue;
        }

        #loading {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        button {
            border: 1px solid black;
            display: block;
            position: relative;
            text-align: center;
            width: 160px;
            height: 50px;
            pointer-events: none;
            opacity: 0.5;
            margin-left: auto;
            margin-right: auto;
            background-color: white;
        }

        button:hover {
            background-color: #f0f;
        }

        button.active {
            pointer-events: initial;
            opacity: 1;
        }

        .description {
            margin: 20px;
        }

        #volumes {
            border: 1px solid black;
            padding: 10px;
            margin-top: 30px;
            width: 140px;
            margin-left: auto;
            margin-right: auto;
        }

        #volumes input {
            display: block;
        }

        h3 {
            margin-top: 0px;
        }
    </style>


    <div id='loading'>
        loading...
    </div>

    <script>
        const piano = new Tone.Sampler({
            urls: {
                A0: "A0.mp3",
                C1: "C1.mp3",
                "D#1": "Ds1.mp3",
                "F#1": "Fs1.mp3",
                A1: "A1.mp3",
                C2: "C2.mp3",
                "D#2": "Ds2.mp3",
                "F#2": "Fs2.mp3",
                A2: "A2.mp3",
                C3: "C3.mp3",
                "D#3": "Ds3.mp3",
                "F#3": "Fs3.mp3",
                A3: "A3.mp3",
                C4: "C4.mp3",
                "D#4": "Ds4.mp3",
                "F#4": "Fs4.mp3",
                A4: "A4.mp3",
                C5: "C5.mp3",
                "D#5": "Ds5.mp3",
                "F#5": "Fs5.mp3",
                A5: "A5.mp3",
                C6: "C6.mp3",
                "D#6": "Ds6.mp3",
                "F#6": "Fs6.mp3",
                A6: "A6.mp3",
                C7: "C7.mp3",
                "D#7": "Ds7.mp3",
                "F#7": "Fs7.mp3",
                A7: "A7.mp3",
                C8: "C8.mp3",
            },
            release: 1,
            baseUrl: "https://tonejs.github.io/audio/salamander/",
        }).toDestination();

        // const loadPiano = piano.load()


        /*
            document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', e => {
                piano[e.target.name].value = parseInt(e.target.value, 10)
            })
        })
        Promise.all([loadPiano]).then(() => {
            document.querySelector('#loading').remove()
            // document.querySelector('button').classList.add('active')
        })
            */
        document.querySelector('#loading').remove()
        /*
        const keyboard = new Tone.MidiInput()
        keyboard.on('keyDown', (e, v) => piano.keyDown(e, undefined, v))
        keyboard.on('keyUp', (e, v) => piano.keyUp(e, undefined, v))
        keyboard.on('pedalDown', () => piano.pedalDown())
        keyboard.on('pedalUp', () => piano.pedalUp())
        */

        const container = document.getElementById('WEBPIANO');
        const keyboard3 = new PianoKeys.Keyboard(container);

        document.querySelectorAll(".keyboardbtn").forEach(btn => {
            btn.addEventListener('mousedown', () => {
                piano.triggerAttack(btn.id, undefined, btn.vel ? btn.vel : 0.8);
                keyboard3.fillKey(btn.id);
            });
            btn.addEventListener('mouseup', () => {
                piano.triggerRelease(btn.id, undefined, btn.vel ? btn.vel : 0.8);
                keyboard3.clearKey(btn.id);
            });
        })

        function hitNote(note, vel) {
            document.querySelector(`[count="${note}"]`).setAttribute("vel", vel);
            document.querySelector(`[count="${note}"]`).dispatchEvent(new Event('mousedown'));
        }
        function unhitNote(note, vel) {
            document.querySelector(`[count="${note}"]`).setAttribute("vel", vel);
            document.querySelector(`[count="${note}"]`).dispatchEvent(new Event('mouseup'));
        }
    </script>
</div>
<div id="loading">loading ...</div>
<div id="WEBPIANO"></div>
<div class="flex items-center mb-4">
    <input onclick="change_setting('show_midi_events', this.checked)" id="midi_events_checkbox" type="checkbox" value=""
        class="w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
    <label for="default-checkbox" class="pl-2 block uppercase
    tracking-wide text-xs font-bold mt-2 text-gray-600 dark:text-gray-400" data-translate="show_midi_events">
        Show midi events (might degrade performance)
    </label>
</div>
<div class="transition duration-300 slide-in-content grid grid-cols-1 gap-6 w-full lg:w-4/5 xl:w-4/5 2xl:w-3/5 m-auto">
    <div class="flex-1 bg-gray-200 dark:bg-gray-700">
        <div class="flex m-4">
            <div class="flex w-1/2">
                <div class="inline pr-2 text-gray-600 dark:text-gray-400" data-translate="input_port">
                    Input port:
                </div>
                <div class="inline overflow-auto" id="input_port">
                </div>
            </div>
            <div class="flex-1 pr-2 text-gray-600 dark:text-gray-400 text-right" data-translate="status">
                Status:
            </div>
            <div class="contents text-right w-20 uppercase" id="recording_status">
            </div>

        </div>

    </div>

    <div class="flex-1 bg-gray-200 dark:bg-gray-700" href="#/">
        <div data-translate="metronome" class="m-4 text-base text-gray-600 dark:text-gray-400 absolute">Metronom</div>
        <div class="grid grid-cols-1 justify-items-center">
            <div class="text-2xl mb-2"><span id="beats_per_minute">160</span> BPM</div>
            <div class="w-full justify-center flex text-sm text-gray-600 dark:text-gray-400">
                20<input onchange="change_bpm(this.value);"
                    oninput="document.getElementById('beats_per_minute').innerHTML = this.value;" id="bpm_slider"
                    class="w-1/2 mx-2" type="range" min="20" max="280">280
            </div>
            <button id="metronome_start" onclick="ticker.start();this.classList.add('hidden');
                        this.nextElementSibling.classList.remove('hidden');
                        is_playing = 1;"
                class="w-20 h-8 outline-none my-2 bg-gray-100 dark:bg-gray-600 font-bold py-2 px-2 rounded-2xl inline-flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-full justify-items-center" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
            <button id="metronome_stop" onclick="ticker.stop();
                    this.classList.add('hidden');
                    this.previousElementSibling.classList.remove('hidden');
                    is_playing = 0;"
                class="w-20 h-8 outline-none my-2 bg-gray-100 dark:bg-gray-600 font-bold py-2 px-2 rounded-2xl inline-flex items-center animate-pulse hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-full justify-items-center" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                </svg>
            </button>
            <div class="grid grid-cols-2 sm:grid-cols-1 justify-items-center">
                <div data-translate="beats_per_measure" class="mt-1 text-base text-gray-600 dark:text-gray-400">Uderzeń
                    na takt
                </div>
                <div class="justify-center flex">
                    <svg onclick="input = document.getElementById('beats_per_measure');
                            input.value = parseInt(input.value) - 1;
                            if(input.value <= 2){input.value = 3};
                            change_beats_per_measure(input.value);" id="subtract_beat_per_measure"
                        xmlns="http://www.w3.org/2000/svg" class="h-8 w-6 cursor-pointer" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <input onchange="if(this.value <= 2){this.value = 3};
                            if(this.value >= 13){this.value = 12};
                            change_beats_per_measure(this.value);" min="3" max="12" type="number"
                        id="beats_per_measure" class="h-8 py-2 px-2 w-20 mb-2
                            rounded-2xl bg-gray-100 dark:bg-gray-600 appearance-none">
                    <svg onclick="input = document.getElementById('beats_per_measure');
                            input.value = parseInt(input.value) + 1;
                            if(input.value >= 13){input.value = 12};
                            change_beats_per_measure(input.value);" id="add_beat_per_measure"
                        xmlns="http://www.w3.org/2000/svg" class="h-8 w-6 cursor-pointer" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>

                <div class="mt-1 text-base text-gray-600 dark:text-gray-400" data-translate="volume">Głośność</div>
                <div class="justify-center flex">
                    <svg onclick="input = document.getElementById('metronome_volume');
                            input.value = parseInt(input.value) - 10;
                            if(input.value <= 0){input.value = 0};
                            change_volume(input.value);" xmlns="http://www.w3.org/2000/svg" class="h-8 w-6" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M 15.536 8.464 C 17.489 10.417 17.489 13.583 15.536 15.536 M 5.586 15 L 4 15 C
                                3.448 15 3 14.552 3 14 L 3 10 C 3 9.448 3.448 9 4 9 L 5.586 9 L 10.293 4.293 C 10.923
                                3.663 12 4.109 12 5 L 12 19 C 12 19.891 10.923 20.337 10.293 19.707 L 5.586 15 Z">
                        </path>
                    </svg>
                    <input onchange="if(this.value <= 0){this.value = 0};
                            if(this.value >= 100){this.value = 100};
                            change_volume(this.value);" value="50" min="0" max="100" step="10" type="number"
                        id="metronome_volume" class="h-8 py-2 px-2 w-20 mb-2
                            rounded-2xl bg-gray-100 dark:bg-gray-600 appearance-none">
                    <svg onclick="input = document.getElementById('metronome_volume');
                            input.value = parseInt(input.value) + 10;
                            if(input.value >= 100){input.value = 100};
                            change_volume(input.value);" xmlns="http://www.w3.org/2000/svg"
                        class="h-8 w-6 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1
                                1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0
                                .891-1.077 1.337-1.707.707L5.586 15z"></path>
                    </svg>
                </div>

            </div>

        </div>
    </div>
</div>